# P5.3 - Informe RA3: Despliegue WildFly + Gradle

**Alumno:** Alberto Rodríguez Villanueva  
**Fecha:** 11 de febrero de 2026  
**Módulo:** Despliegue de Aplicaciones Web  

---

## a) Componentes y funcionamiento

En mi despliegue de la P5.2 he usado los siguientes componentes:

- **Docker**: Para ejecutar WildFly en un contenedor aislado
- **WildFly**: Es el servidor de aplicaciones donde corre mi API REST
- **Puerto 8080**: Por donde accedo a la aplicación
- **Puerto 9990**: Para la consola de administración de WildFly
- **El WAR**: Es el archivo que contiene mi aplicación compilada

### ¿Cómo funciona una petición?

Cuando hago una petición a `http://localhost:8080/myproject/module/backend/api/myservice/hello`:

1. El navegador envía la petición al puerto 8080
2. Docker la redirige al contenedor de WildFly
3. WildFly mira el context path `/myproject/module/backend` y sabe que es mi aplicación
4. Busca `/api` que está definido en RestApplication.java
5. Busca `/myservice/hello` que está en MyService.java
6. Ejecuta el método y devuelve "hello!"

### Evidencias

**docker ps mostrando el contenedor:**

![alt text](<capturas/5.2 Captura 3.png>)

**Logs del despliegue:**

![alt text](<capturas/5.2 Captura 2.png>)
```powershell
docker logs wildfly --tail 10
```

**Respuesta del endpoint:**
![alt text](<capturas/5.2 Captura 8.png>)

```powershell
curl.exe http://localhost:8080/myproject/module/backend/api/myservice/hello
# Respuesta: hello!
```

---

## b) Archivos de configuración y dependencias

### Configuración de WildFly

El archivo principal de configuración está en:
```
/opt/jboss/wildfly/standalone/configuration/standalone.xml
```

Ahí se pueden configurar cosas como:
- Conexiones a bases de datos
- Puertos del servidor
- Niveles de log
- Seguridad

Para verlo ejecuté:
```powershell
docker exec -it wildfly ls /opt/jboss/wildfly/standalone/configuration/
```

### Dependencias "provided"

En el `build.gradle.kts` uso `compileOnly` para Jakarta EE:

```kotlin
dependencies {
    compileOnly("jakarta.platform:jakarta.jakartaee-api:10.0.0")
}
```

Esto significa que la dependencia solo se usa para compilar, pero no se mete dentro del WAR. ¿Por qué? Porque WildFly ya trae todas las librerías de Jakarta EE incluidas. Así el WAR pesa solo 6KB en vez de varios megas.

### Evidencias

**Listado de configuración:**

![alt text](<capturas/5.2 Captura 10.png>)

**build.gradle.kts:**

![alt text](<capturas/5.2 Captura 11.png>)


---

## c) Reverse proxy y HTTPS

### Situación actual

En la P5.2 accedo directamente a WildFly por el puerto 8080. Esto está bien para desarrollo pero en producción no es lo ideal.

### Con Nginx delante

En producción pondría Nginx delante de WildFly para:
- Tener HTTPS (los datos van cifrados)
- Ocultar el puerto 9990 de administración
- Tener URLs más limpias como `/api/` en vez de `/myproject/module/backend/api/`

He creado un `nginx.conf` con esta configuración:

```nginx
http {
    upstream wildfly {
        server wildfly:8080;
    }

    server {
        listen 80;
        location /api/ {
            proxy_pass http://wildfly/myproject/module/backend/api/;
        }
    }

    server {
        listen 443 ssl;
        ssl_certificate /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;
        
        location /api/ {
            proxy_pass http://wildfly/myproject/module/backend/api/;
        }
    }
}
```

### Generación de certificados

Para desarrollo usé certificados autofirmados:
```powershell
# Crear carpeta para certificados
mkdir certs

# Generar certificado autofirmado (requiere OpenSSL instalado)
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout certs/server.key -out certs/server.crt -subj "/CN=localhost"
```

### ¿Hay que cambiar algo en WildFly?

No, WildFly sigue igual. El cifrado HTTPS lo hace Nginx, no WildFly. Esto se llama "SSL Termination".

### Evidencias

**nginx.conf:**

![alt text](<capturas/5.2 Captura 12.png>)
---

## d) Seguridad

### Lo que hice en P5.2

- Creé un usuario de administración con `add-user.sh`
- Solo mapeé los puertos necesarios (8080, 9990)

### Medidas para producción

**1. No exponer el puerto 9990**

En desarrollo lo expongo por comodidad, pero en producción no debería estar accesible desde fuera:
```powershell
# Solo puerto de aplicación
docker run -d --name wildfly -p 8080:8080 ...
```

**2. HTTPS obligatorio**

Los datos sin cifrar se pueden interceptar. Con HTTPS todo va cifrado.

**3. Guardar contraseñas de forma segura**

No meter contraseñas en el código. Usar Docker Secrets o variables de entorno seguras.

**4. Persistir los logs**

Si el contenedor se borra, se pierden los logs. Hay que montar un volumen:
```yaml
volumes:
  - ./logs:/opt/jboss/wildfly/standalone/log
```

### Evidencias

**Puertos expuestos:**

![alt text](<capturas/5.2 Captura 3.png>)

**Usuario creado:**

![alt text](<capturas/5.2 Captura 10.png>)

```powershell
docker exec -it wildfly /opt/jboss/wildfly/bin/add-user.sh
```

---

## e) Componentes web

### ¿Qué es el WAR?

El WAR es un archivo ZIP que contiene mi aplicación:
- Las clases Java compiladas (.class)
- El archivo jboss-web.xml con la configuración
- Recursos estáticos si los hubiera

### Context path

El context path es la ruta base de la aplicación. Lo defino en `jboss-web.xml`:

```xml
<jboss-web>
    <context-root>/myproject/module/backend</context-root>
</jboss-web>
```

### Desglose de la URL

```
http://localhost:8080/myproject/module/backend/api/myservice/hello
     |___________|__|__________________________|___|________|_____|
      host:puerto        context path           app  recurso método
```

### Evidencias

**Navegador - /hello:**


![alt text](<capturas/5.2 Captura 8.png>)

**Navegador - /pojo/list:**


![alt text](<capturas/5.2 Captura 9.png>)

---

## f) Parámetros del despliegue

Los parámetros que usé para arrancar WildFly:

```powershell
docker run -d `
  --name wildfly `
  -p 8080:8080 `
  -p 9990:9990 `
  quay.io/wildfly/wildfly:latest `
  /opt/jboss/wildfly/bin/standalone.sh `
  -b 0.0.0.0 `
  -bmanagement 0.0.0.0
```

| Parámetro | Para qué sirve | Si falta... |
|-----------|----------------|-------------|
| `-d` | Ejecutar en 2º plano | Se queda bloqueada la terminal |
| `--name wildfly` | Nombre del contenedor | Pone un nombre aleatorio |
| `-p 8080:8080` | Mapear puerto HTTP | No puedo acceder a la app |
| `-p 9990:9990` | Mapear puerto admin | No puedo administrar |
| `-b 0.0.0.0` | Escuchar en todas las IPs | Solo funciona desde dentro del contenedor |
| `-bmanagement 0.0.0.0` | Admin desde fuera | Error al entrar a la consola |

Para desplegar el WAR:
```powershell
docker cp target/modulename.backend.war wildfly:/opt/jboss/wildfly/standalone/deployments/
```

---

## g) Pruebas de funcionamiento y rendimiento

### Pruebas funcionales

Probé todos los endpoints con curl (en PowerShell uso `curl.exe` para usar el curl real):

```powershell
# GET hello
curl.exe http://localhost:8080/myproject/module/backend/api/myservice/hello
# Resultado: hello!

# GET lista
curl.exe http://localhost:8080/myproject/module/backend/api/myservice/pojo/list
# Resultado: [{"id":1,"name":"LALALA"},{"id":2,"name":"LElele"}]

# POST crear
curl.exe -X POST -H "Content-Type: application/json" -d '{\"id\":\"123\", \"name\":\"Test\"}' http://localhost:8080/myproject/module/backend/api/myservice/pojo/new
# Resultado: 201 Created

# PUT actualizar
curl.exe -X PUT -H "Content-Type: application/json" -d '{\"id\":\"55\", \"name\":\"Raul\"}' http://localhost:8080/myproject/module/backend/api/myservice/pojo/update
# Resultado: 204 No Content

# DELETE borrar
curl.exe -X DELETE "http://localhost:8080/myproject/module/backend/api/myservice/pojo/remove?id=3"
# Resultado: 204 No Content
```

### Prueba de rendimiento

Usé ApacheBench para hacer 1000 peticiones con 10 conexiones simultáneas:

```powershell
ab.exe -n 1000 -c 10 http://localhost:8080/myproject/module/backend/api/myservice/pojo/list
```

**Nota:** Si no tienes ApacheBench instalado, viene con Apache/XAMPP o puedes usar alternativas como `wrk` (instalar con Chocolatey: `choco install wrk`)

Resultados:
- **Peticiones por segundo:** ~820
- **Tiempo por petición:** ~12ms
- **Peticiones fallidas:** 0

El servidor aguanta bien la carga y no hubo ningún error.

### Evidencias

**Pruebas curl:**

![alt text](<capturas/5.2 Captura 13 GET.png>)
![alt text](<capturas/5.2 Captura 13 GET2.png>)
![alt text](<capturas/5.2 Captura 13 POST PUT DELETE.png>)


**Prueba de rendimiento:**

![alt text](<capturas/5.2 Captura 15.png>)

---

## h) Guía de administración

### Cómo levantar WildFly

```powershell
# Descargar imagen (solo la primera vez)
docker pull quay.io/wildfly/wildfly:latest

# Arrancar contenedor
docker run -d --name wildfly -p 8080:8080 -p 9990:9990 quay.io/wildfly/wildfly:latest /opt/jboss/wildfly/bin/standalone.sh -b 0.0.0.0 -bmanagement 0.0.0.0

# Ver si está funcionando
docker ps
docker logs wildfly
```

### Cómo desplegar una nueva versión

```powershell
# Compilar
mvn clean package

# Copiar al contenedor
docker cp target/modulename.backend.war wildfly:/opt/jboss/wildfly/standalone/deployments/

# Ver los logs para confirmar
docker logs wildfly --tail 10
```

### Cómo comprobar el estado

```powershell
# Ver logs
docker logs -f wildfly

# Probar endpoint
curl.exe http://localhost:8080/myproject/module/backend/api/myservice/hello
```

### Comandos útiles

| Qué hacer | Comando |
|-----------|---------|
| Ver logs en vivo | `docker logs -f wildfly` |
| Parar WildFly | `docker stop wildfly` |
| Arrancar WildFly | `docker start wildfly` |
| Reiniciar | `docker restart wildfly` |
| Entrar al contenedor | `docker exec -it wildfly bash` |

### Errores comunes

| Error | Causa | Solución |
|-------|-------|----------|
| Connection refused | Contenedor parado | `docker start wildfly` |
| 404 Not Found | WAR no desplegado | Verificar logs y copiar WAR de nuevo |
| Unable to redirect | Falta -bmanagement | Recrear contenedor con el parámetro |

---

## i) Docker Compose

Para el despliegue completo creé un `docker-compose.yml` que levanta Nginx + WildFly juntos:

```yaml
version: '3.8'

services:
  wildfly:
    image: quay.io/wildfly/wildfly:latest
    container_name: wildfly
    command: /opt/jboss/wildfly/bin/standalone.sh -b 0.0.0.0 -bmanagement 0.0.0.0
    volumes:
      - ./practica-jakarta-wildfly/target/modulename.backend.war:/opt/jboss/wildfly/standalone/deployments/modulename.backend.war
      - wildfly-logs:/opt/jboss/wildfly/standalone/log
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/myproject/module/backend/api/myservice/hello"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
    depends_on:
      - wildfly
    networks:
      - app-network
    restart: unless-stopped

volumes:
  wildfly-logs:

networks:
  app-network:
```

### Lo que incluye

- Volúmenes para que los logs no se pierdan
- Healthcheck para saber si WildFly está funcionando
- Reinicio automático si se cae
- Red interna entre los contenedores
- Solo Nginx expuesto al exterior (puertos 80 y 443)
- WildFly no accesible directamente desde fuera

### Cómo usarlo

```powershell
# Generar certificados
mkdir certs
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout certs/server.key -out certs/server.crt -subj "/CN=localhost"

# Compilar la app
cd practica-jakarta-wildfly
mvn clean package
cd ..

# Levantar todo
docker-compose up -d

# Ver estado
docker-compose ps

# Probar
curl.exe http://localhost/api/myservice/hello
curl.exe -k https://localhost/api/myservice/hello
```

### Evidencias

**docker-compose.yml:**

![alt text](<capturas/5.2 Captura 14.png>)

**Acceso por Nginx:**
![alt text](<capturas/5.2 Captura 8.png>)
